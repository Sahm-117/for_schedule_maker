#!/usr/bin/env node

// Test script to verify the user cleanup and pending changes functionality
const axios = require('axios');

const BASE_URL = 'http://localhost:3001';

// Test data
let adminToken = '';
let supportToken = '';
let testWeekId = 1;

async function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function testAdminLogin() {
  console.log('üîë Testing Admin Login...');
  try {
    const response = await axios.post(`${BASE_URL}/api/auth/login`, {
      email: 'admin@test.com',
      password: 'admin123'
    });

    adminToken = response.data.token;
    console.log('‚úÖ Admin login successful');
    return true;
  } catch (error) {
    console.log('‚ùå Admin login failed:', error.response?.data?.error || error.message);
    return false;
  }
}

async function testSupportLogin() {
  console.log('üîë Testing Support User Login...');
  try {
    const response = await axios.post(`${BASE_URL}/api/auth/login`, {
      email: 'support@test.com',
      password: 'support123'
    });

    supportToken = response.data.token;
    console.log('‚úÖ Support login successful');
    return true;
  } catch (error) {
    console.log('‚ùå Support login failed:', error.response?.data?.error || error.message);
    return false;
  }
}

async function testCreateSupportActivity() {
  console.log('üìù Testing Support User Activity Creation...');
  try {
    // First get weeks to find a day
    const weeksResponse = await axios.get(`${BASE_URL}/api/weeks`, {
      headers: { Authorization: `Bearer ${supportToken}` }
    });

    const firstWeek = weeksResponse.data.weeks[0];
    const firstDay = firstWeek.days[0];

    const response = await axios.post(`${BASE_URL}/api/activities/request`, {
      dayId: firstDay.id,
      time: '10:30',
      description: 'Test support activity - cleanup verification',
      period: 'MORNING',
      userId: 'test-support-user-id'
    }, {
      headers: { Authorization: `Bearer ${supportToken}` }
    });

    console.log('‚úÖ Support activity creation successful');
    return { weekId: firstWeek.id, dayId: firstDay.id };
  } catch (error) {
    console.log('‚ùå Support activity creation failed:', error.response?.data?.error || error.message);
    return null;
  }
}

async function testPendingChanges(weekId) {
  console.log('üìã Testing Pending Changes Display...');
  try {
    const response = await axios.get(`${BASE_URL}/api/weeks/${weekId}`, {
      headers: { Authorization: `Bearer ${adminToken}` }
    });

    const pendingChanges = response.data.pendingChanges;
    console.log(`üìä Found ${pendingChanges.length} pending changes`);

    if (pendingChanges.length > 0) {
      const firstChange = pendingChanges[0];
      if (firstChange.user && firstChange.user.name) {
        console.log(`‚úÖ User display working: "${firstChange.user.name}" (${firstChange.user.email})`);
        return firstChange.id;
      } else {
        console.log('‚ùå User info missing in pending change');
        console.log('Pending change data:', JSON.stringify(firstChange, null, 2));
        return null;
      }
    } else {
      console.log('‚ÑπÔ∏è  No pending changes found');
      return null;
    }
  } catch (error) {
    console.log('‚ùå Failed to fetch pending changes:', error.response?.data?.error || error.message);
    return null;
  }
}

async function testApproval(changeId) {
  if (!changeId) {
    console.log('‚è≠Ô∏è  Skipping approval test - no pending changes');
    return true;
  }

  console.log('‚úÖ Testing Pending Change Approval...');
  try {
    const response = await axios.put(`${BASE_URL}/api/pending-changes/${changeId}/approve`, {}, {
      headers: { Authorization: `Bearer ${adminToken}` }
    });

    console.log('‚úÖ Approval successful');
    console.log(`üìä Results: ${response.data.results.length} activities created`);
    return true;
  } catch (error) {
    console.log('‚ùå Approval failed:', error.response?.data?.error || error.message);
    console.log('Error details:', error.response?.data?.details || 'No details');
    return false;
  }
}

async function testUsersList() {
  console.log('üë• Testing Users List...');
  try {
    const response = await axios.get(`${BASE_URL}/api/users`, {
      headers: { Authorization: `Bearer ${adminToken}` }
    });

    const users = response.data.users;
    console.log(`üìä Found ${users.length} users:`);
    users.forEach(user => {
      console.log(`  - ${user.name} (${user.email}) - ${user.role}`);
    });

    return true;
  } catch (error) {
    console.log('‚ùå Failed to fetch users:', error.response?.data?.error || error.message);
    return false;
  }
}

async function runTests() {
  console.log('üß™ Starting User Cleanup Verification Tests\n');

  // Test login
  const adminLoginOk = await testAdminLogin();
  if (!adminLoginOk) {
    console.log('‚ùå Cannot continue without admin access');
    return;
  }

  const supportLoginOk = await testSupportLogin();
  if (!supportLoginOk) {
    console.log('‚ùå Cannot continue without support access');
    return;
  }

  await delay(500);

  // Test users list
  await testUsersList();
  await delay(500);

  // Test activity creation
  const activityResult = await testCreateSupportActivity();
  await delay(500);

  // Test pending changes display
  let changeId = null;
  if (activityResult) {
    changeId = await testPendingChanges(activityResult.weekId);
    await delay(500);
  }

  // Test approval
  await testApproval(changeId);

  console.log('\nüéâ Testing Complete!');

  if (changeId) {
    console.log('‚úÖ All tests passed - Unknown User issue appears to be resolved!');
  } else {
    console.log('‚ÑπÔ∏è  Tests completed but no pending changes were found to verify user display');
  }
}

runTests().catch(console.error);